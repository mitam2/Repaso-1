# Práctico Final
# Estudiantes: Muriel Encina y José Miguel Valdés
# Curso: Métodos y técnicas de investigación I
# Profesor: Ismael Puga
# Ayudante: Charo Astorga
# Universidad Alberto Hurtado, Magíster en Sociología




# 0. Ajustes iniciales -----------------------------------

# 0.1 Desactivar notación científica

options(scipen=999)

# 1. Instalar y cargar paquetes ---------------------


pacman::p_load(dplyr,     #Manipular datos
               haven,      #Cargar y exportar bases de datos en distintos formatos
               tidyverse,  #Colección de paquetes (dplyr y haven)
               sjPlot,     #Analizar datos
               sjmisc,     #Explorar datos
               ggpubr,     #Visualización gráfico de dispersión
               lmtest,     #Regresiones
               car)        #Para prueba


# 2. Importar datos ------------------

datos <- read_dta("input/data/EPSOC2018 - trabajo practico.dta") #cargamos la base de datos original

# 3. Explorar datos ----------------

dim(datos)
names(datos)
head(datos)



# 4. Seleccionar y codificar variables a utilizar

datos_proc <- datos %>%
  select(ego_ideo_edu, ego_sd_income, ego_sd_classid, ego_sd_gender, ego_sd_age, ego_sd_educ, ego_pol_spectrum) %>%
  rename(
    postura_educacion = ego_ideo_edu,    # Escala de percepción sobre educación
    salario = ego_sd_income,             # Salario en miles de pesos
    clase_social = ego_sd_classid,       # Autoidentificación clase social
    genero = ego_sd_gender,              # Género de la persona (género femenino sí o no)
    edad = ego_sd_age,                   # Edad
    nivel_educativo = ego_sd_educ,       # Nivel educativo de la persona
    posicion_politica = ego_pol_spectrum) %>%  # Posición política de la persona 
  mutate(  #transformamos la variable clase social en variables dummy
    clase_alta = ifelse(clase_social == 1, 1, 0),
    clase_media_alta = ifelse(clase_social == 2, 1, 0),
    clase_media_baja = ifelse(clase_social == 3, 1, 0),
    clase_baja = ifelse(clase_social == 4, 1, 0) 
) %>%
  mutate(
    # Convertimos la variable de nivel educativo en variables dummy
    sin_primaria_completa = ifelse(nivel_educativo == 1, 1, 0),  # Sin completar la primaria
    secundaria_incompleta = ifelse(nivel_educativo == 2, 1, 0),  # Secundaria incompleta
    secundaria_completa = ifelse(nivel_educativo == 3, 1, 0),  # Secundario completo
    terciaria_incompleta = ifelse(nivel_educativo == 4, 1, 0),  # Terciario incompleto
    tecnico = ifelse(nivel_educativo == 5, 1, 0),  # Técnico
    profesional = ifelse(nivel_educativo == 6, 1, 0),  # Profesional
    posgrado = ifelse(nivel_educativo == 7, 1, 0))  # Post-grados
    
 

 
#Visualizamos datos

head(datos_proc)

frq(datos_proc$ego_sd_region)
  


frq(datos_proc$nivel_educativo)
frq(datos_proc$posiciion_politica)
frq(datos_proc$clase_social)


# 5. Regresión lineal Multiple


## 5.1 Creacion de modelos 


# Modelo 1 (postura sobre educación y clase social dummy; variable de referencia)

# H0: La clase social (clase alta, clase media-alta, clase media-baja y clase baja como referencia) no tiene un efecto significativo sobre la postura en educación
# H1: La clase social tiene un efecto significativo sobre la postura educativa

m1 = lm(postura_educacion ~ clase_alta+clase_media_alta+clase_media_baja, data = datos_proc)
summary(m1)

#Intercepto: 9.0749. Este es el valor estimado de la postura sobre la educación para la clase baja (referencia) cuanto todas las demás variables son cero. Es decir, el valor promedio de la postura sobre la educacion para las personas de clase baja es de 9.0749
#Clase alta: Tiene un coeficiente de -2.0749, lo que indica que las personas de clase alta tienen una postura sobre la educacion en promedio 2.0749 unidades menor que las personas de clase baja
#Clase media alta: Tiene un coeficiente de -1.9103, lo que indica que las personas de clase media-alta tienen una postura sobre la educacion 1.9103 unidades mejor que las personas de clase baja
#Clase media baja: Tiene un coeficiente de -0.8505, lo que indica que las personas de clase media-baja tiene una postura sobre la educación 0.8505 unidades mejor que las personas de clase baja

#Respecto al R2 ajustado del modelo, este posee un coeficiente de 0.01985, lo que indica que solo el 1,99% de la variabilidad de la postura sobre la educacion puede ser explicada por las clases sociales. Por lo tanto, sugiere que el modelo no es muy fuerte para poder explicar las diferencias en postura educativa con la variable clase social, y hace necesario incluir otras variables que pueden estar influyendo.  







# Modelo 2 (postura educacion con clase social y nivel educativo, donde secundaria completa es la referencia)

# H0= La clase social y el nivel educativo (primaria incompleta, secundaria incompleta, terciaria incompleta, tecnico, profesional y posgrado) no tiene un efecto significativo en la postura sobre educación
# H1= La clase social y el nivel educativo tienen un efecto significativo en la postura sobre la educación

m2 = lm(postura_educacion ~ clase_alta+clase_media_alta+clase_media_baja+sin_primaria_completa+secundaria_incompleta+terciaria_incompleta+tecnico+profesional+posgrado, data = datos_proc)
summary(m2)

#Intercepto de 9.0086, lo que indica que la postura sobre educación promedio de una persona de clase baja y con secundaria completa es de aproximadamente 9 cuando todas las demas variables son 0.

#Clase alta: Tiene un coeficiente de -2.3270, pero no es significativo. Esto sugiere que, en promedio, las personas de clase alta tienden a tener una postura en educación 2.33 puntos más baja que la clase baja
#Clase media-alta: Tiene un coeficiente de -1.6851, siendo significativo. Esto sugiere que, en promedio, las personas de clase media alta tienen una postura en educacion 1.69 puntos más baja que la clase baja
#Clase media-baja: Tiene un coeficiente de -0.6755, siendo significativo. Esto sugiere que, en promedio, las personas de clase media baja tienen una postura 0.67 puntos más baja que la clase baja

#Sin primaria completa, secundaria incompleta, terciaria incompleta, técnico, profesional y posgrado no muestran efectos estisticamente significativos 

#El R2 ajustado es de 0.02141, lo que indica que el modelo explica solo el 2.83% de la variabilidad en la postura sobre la educación. Lo que indica que hay otras variables que influyen en la variabilidad de la postura sobre la educación





# Modelo 3 (postura en educación con clase social, nivel educativo y posicion politica)

m3 = lm(postura_educacion ~ clase_alta+clase_media_alta+clase_media_baja+sin_primaria_completa+secundaria_incompleta+terciaria_incompleta+tecnico+profesional+posgrado+posicion_politica, data = datos_proc)
summary(m3)

#H0: La clase social, el nivel educativo y la posicion politica no tienen un efecto significativo sobre la postura en educación
#H1: La clase social, el nivel educativo y la posicion politica tienen un efecto significativo sobre la postura en educación


#Para clase alta
#H0: No hay un efecto significativo de ser de clase alta sobre la postura en educación en comparación a la clase baja
#H1: Ser de clase alta tiene un efecto significativo sobre la postura en educación en comparación a la clase baja

#Para clase media-alta
#H0: No hay un efecto significativo de ser clase media-alta sobre la postura en educación en comparación con la clase baja
#H1: Ser de clase media-alta tiene un efecto significativo sobre la postura en educación en comparación con la clase baja

#Para clase media-baja
#H0: No hay un efecto significativo de ser de clase media-baja sobre la postura en educación en comparación con la clase baja
#H1: Ser de clase media-baja tiene un efecto significativo en la postura en educación en comparación con la clase baja

#Para posición política
#H0: No hay un efecto significativo de la posición política sobre la postura en educación
#H1: La posición política tiene un efecto significativo sobre la postura en educación

#Para sin primaria completa
#H0: No hay un efecto significativo de no tener la primaria completa sobre la postura en educación en comparación con tener secundaria completa
#H1: No tener la primaria completa tiene un efecto significativo sobre la postura en educación en comparación con teber secundaria completa

#Para secundaria incompleta
#H0: No hay un efecto significativo de no tener la secundaria completa sobre la postura en educación en comparación con tener secundaria completa
#H1: No tener la secundaria completa tiene un efecto significativo sobre la postura en educación en comparación con tener la secundaria completa

#Para terciaria incompleta
#H0: No hay un efecto significativo de no tener la educación terciaria completa sobre la postura en educación en comparación con tener la secundaria completa
#H1: No tener educación terciaria completa tiene un efecto significativo sobre la postura en educación en comparación con tener la secundaria completa

#Para técnico
#H0: No hay un efecto significativo de tener educación técnica sobre la postura en educacion en comparación con tener la secundaria completa
#H1: Tener educacion tecnica tiene un efecto sigfnificativo sobre la postura en educacion en comparacion a tener secundaria completa

#Para profesional
#H0: No hay un efecto significativo de tener educacion profesional sobre la postura en educacion en comparacion a tener secundaria completa 
#H1: Tener educación profesional tiene un efecto significativo sobre la postura en educación en comparación a tener secundaria completa


#Para posgrado
#H0: No hay un efecto significativo en tener estudios de posgrado sobre la postura en educación en comparacion a tener secundaria completa
#H1 Tener estudios de posgrado tiene un efecto significativo sobre la postura en educacion  en comparacion a tener secundaria completa 


# El intercepto es de 11.20867, lo que representaria la postura promedio sobre educacion para un individuo que pertenece a la clase baja (categoria de referencia), tiene educacion secundaria completa (categoria de referencia para el nivel educativo) y es de izquierda (posición politica = 0)

#Variables significativas de este modelo:

#Clase media alta (coefiente de -1.61): Las personas de clase media alta tienen, en promedio, una postura educativa 1.61 puntos más baja que las personas de clase social baja, manteniendo constantes las demás variables.
#Clase media baja (-0.65): Las personas de clase media baja tienen, en promedio, una postura educativa 0.65 puntos más baja que las personas de clase social baja.
#Posición política (-0.39): Por cada unidad hacia la derecha en la escala de posición política, la postura educativa disminuye en 0.39 puntos, manteniendo constantes las demás variables.
#Sin primaria completa (+1.07): Las personas sin primaria completa tienen una postura educativa 1.07 puntos más alta, en promedio, que las personas con secundaria completa.

#Variables no significativas: clase alta, secundaria incompleta, terciaria incompleta, técnico, profesional y posgrado


# Sobre el R2 ajustado, con un valor de 0.077, El modelo explica solo el 7.7% de la variabilidad en la postura educativa. Es un valor bajo, pero indica que hay otros factores que influyen en la postura sobre la educación no integrados al modelo.





#modelo 4 (postura en educacion con clase social, nivel educativo, posicion politica y salario)

#H0:
#H1:

m4 = lm(postura_educacion ~ clase_alta+clase_media_alta+clase_media_baja+sin_primaria_completa+secundaria_incompleta+terciaria_incompleta+tecnico+profesional+posgrado+posicion_politica+salario, data = datos_proc)
summary(m4)

#Intercepto: Tiene un coeficiente de 11.20297. Esto representa la postura esperada para el grupo de referencia, es decir, aquellos que pertenecen a la clase baja y nivel educativo con secundaria completa.

#Clase alta tiene un coeficiente de -2.52 es decir con una tendencia menor en 2.52 puntos en comparación con la clase baja, pero no es significativa
#Clase media alta tiene un coeficiente de -1.74, indicando que este grupo tiene una postura sobre la educacion aproximadamente 1.74 puntos menos que la clase baja
#Clase media baja tiene un coeficiente de -0.56 pero no es significativa.

#Respecto al nivel educativo, ninguna de las categorias muestran un efecto estadisticamente significativo en la postura sobre educación. Lo que sugiere que en este modelo el nivel educativo no tiene un impacto claro sobre la postura hacia la educación

#Posición política tiene un coeficiente de -0.36. Esto implica que a medida que la posición política aumenta en una unidad hacia la "derecha", la postura educativa disminuye en promedio 0.36 puntos. Es decir, hay una asociación negativa entre una posición política más conservadora y una postura sobre la educación donde esta sea gratuita y publica para todos.

#Salario o ingreso tiene un coeficiente negativo y muy bajo, cercano a cero, lo que indica que el salario tiene un impacto practicamente nulo en la postura educativa

#El R2 ajustado es de 0.077, lo que indica que el modelo explica aproximadamente un 7.7% de la variabilidad total en la postura educativa. Esto es un valor bajo, lo que sugiere que hay otros factores importantes no cinluidos en el modelo






m5 = lm(postura_educacion ~ edad+genero, data = datos_proc)
summary(m5)

# El intercepto tiene un coeficiente de 8.107, que es el valor promedio de la postura educativa cuando se es de un genero masculino y la edad es 0.

# El coeficiente de género es de -0.318, lo que indica que, en promedio, las personas de género femenino tienen una puntuacion en la postura educativa 0.318 unidades mejor que los hombres, pero que no es significativ
# Respecto a la edad, el coeficiente es de 0.0085, lo que sugiere que por cada aumento de un año en la edad, la postura educativa aumenta en promedio 0.0085 unidades, pero igualmente no es significativo

#El R2 ajustado tiene un valor de 0.0005512, lo que explica el 0,05% de la variabilidad de la postura en educación, lo que es un porcentaje muy bajo.



## 5.2Creacion de la tabla con todos los modelos


sjPlot::tab_model(list(m1,m2,m3,m4,m5), # seleccionamos todos los modelos
                  show.ci=FALSE, # no mostrar intervalo de confianza (por defecto lo hace)
                  p.style = "stars", # asteriscos de significación estadística
                  dv.labels = c("Modelo 1", "Modelo 2","Modelo 3", "Modelo 4", "Modelo 5"), # etiquetas de modelos o variables dep.
                  string.pred = "Predictores", 
                  string.est = "β", # nombre predictores y símbolo beta en tabla
                  string.intercept = "(Intercepto)", # mostrar intercepto
                  digits = 3, #3 dígitos
                  encoding =  "UTF-8",
                  lang = "es") #columnas en español





# Prueba de tolerancia

vif_valores = vif(m3) #calcula VIF
vif_valores #muestra VIF


tolerancia = 1 / vif_valores
tolerancia #muestra la tolerancia


saveRDS(datos_proc, file = "output/datos procesados/datos_proc.rds")
 

